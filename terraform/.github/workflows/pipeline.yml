name: Secure CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: secure-cicd-app
  FAIL_ON_HIGH: true

jobs:
  secrets-scan:
    name: Secrets Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install
      
      - name: Run git-secrets
        run: |
          git secrets --install
          git secrets --register-aws
          git secrets --scan -r .
      
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  iac-scan:
    name: Infrastructure Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: json
          output_file_path: reports/checkov-results.json
          soft_fail: false
      
      - name: Upload Checkov results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: checkov-results
          path: reports/checkov-results.json

  dockerfile-scan:
    name: Dockerfile Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy on Dockerfile
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'sample-app/Dockerfile'
          format: 'sarif'
          output: 'trivy-dockerfile-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-dockerfile-results.sarif'

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [secrets-scan, iac-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd sample-app
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: |
          cd sample-app
          pytest tests/ \
            --verbose \
            --junitxml=../reports/junit.xml \
            --cov=src \
            --cov-report=xml:../reports/coverage.xml \
            --cov-report=html:../reports/coverage-html
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: reports/

  build-and-scan:
    name: Build & Scan Container
    runs-on: ubuntu-latest
    needs: [unit-tests]
    permissions:
      id-token: write
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./sample-app
          file: ./sample-app/Dockerfile
          push: false
          load: true
          tags: |
            ${{ env.ECR_REPOSITORY }}:${{ github.sha }}
            ${{ env.ECR_REPOSITORY }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Generate vulnerability report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          format: 'json'
          output: 'trivy-results.json'
      
      - name: Check vulnerability thresholds
        run: |
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json)
          
          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high vulnerabilities"
            if [ "$FAIL_ON_HIGH" = "true" ]; then
              exit 1
            fi
          fi
      
      - name: Configure AWS credentials
        if: github.ref == 'refs/heads/main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        if: github.ref == 'refs/heads/main'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Push to ECR
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ env.ECR_REPOSITORY }}:${{ github.sha }} ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          docker tag ${{ env.ECR_REPOSITORY }}:${{ github.sha }} ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest

  policy-check:
    name: Policy Validation
    runs-on: ubuntu-latest
    needs: [build-and-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v0.59.0/opa_linux_amd64_static
          chmod 755 opa
          sudo mv opa /usr/local/bin/
      
      - name: Test OPA policies
        run: |
          opa test policies/opa -v
      
      - name: Create deployment input
        run: |
          cat > deployment-input.json << EOL
          {
            "environment": "staging",
            "deployment_time": {
              "day": "$(date +%a)",
              "hour": $(date +%H)
            },
            "test_results": {
              "passed": 10,
              "failed": 0
            },
            "security_scan": {
              "critical_count": 0,
              "high_count": 0,
              "medium_count": 0
            },
            "policy_violations": [],
            "build_status": "success",
            "approval": {
              "approved": true
            }
          }
          EOL
      
      - name: Evaluate deployment policy
        run: |
          opa eval \
            --data policies/opa/deployment.rego \
            --data policies/opa/data.json \
            --input deployment-input.json \
            --format pretty \
            'data.deployment.allow'

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secrets-scan, iac-scan, dockerfile-scan, build-and-scan, policy-check]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ IaC Scan: ${{ needs.iac-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dockerfile Scan: ${{ needs.dockerfile-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Container Scan: ${{ needs.build-and-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Policy Check: ${{ needs.policy-check.result }}" >> $GITHUB_STEP_SUMMARY
